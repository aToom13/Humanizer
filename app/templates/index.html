<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atom Humanizer | Make AI Write Like a Human</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a23;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f1f1f4;
            --text-secondary: #a1a1aa;
            --border: #27272a;
            --human: #10b981;
            --ai: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Glow Effects */
        .glow-text {
            text-shadow: 0 0 20px var(--accent-glow);
        }

        .card-glow {
            box-shadow: 0 0 0 1px var(--border), 0 4px 20px -4px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .card-glow:hover {
            box-shadow: 0 0 0 1px var(--accent), 0 8px 30px -4px var(--accent-glow);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }

        /* Animations */
        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slide-up 0.5s ease-out;
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--accent);
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: var(--accent);
        }

        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            stroke-linecap: round;
        }

        /* Glass Effect */
        .glass {
            background: rgba(26, 26, 35, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Input Focus Effects */
        .input-focus:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-glow), 0 0 0 1px var(--accent);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px var(--accent-glow);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .tab-active {
            background: var(--accent);
            color: white;
        }

        .syntax-keyword {
            color: #c678dd;
        }

        .syntax-string {
            color: #98c379;
        }

        .syntax-func {
            color: #61afef;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-950 via-[#0a0a0f] to-slate-900">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass border-b border-zinc-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <i data-lucide="activity" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight">Atom Humanizer</h1>
                    <p class="text-xs text-zinc-400">Make AI write like a tired student</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="toggleSettings()"
                    class="p-2 rounded-lg hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-white">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <div class="h-4 w-px bg-zinc-700"></div>
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-zinc-900 border border-zinc-800">
                    <div id="connection-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-xs text-zinc-400 mono">API: <span id="connection-status">Connected</span></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleSettings()"></div>
        <div
            class="absolute right-0 top-0 h-full w-full max-w-md bg-[#12121a] border-l border-zinc-800 p-6 overflow-y-auto animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">API Settings</h2>
                <button onclick="toggleSettings()" class="p-2 hover:bg-zinc-800 rounded-lg">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-sm text-zinc-400 font-medium">AI Provider</label>
                    <select id="providerSelect" onchange="updateProviderFields()"
                        class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm focus:border-indigo-500 focus:outline-none transition-colors">
                        <option value="gemini">Google Gemini (Free)</option>
                        <option value="openrouter">OpenRouter (Multi Model)</option>
                        <option value="ollama">Ollama (Local)</option>
                    </select>
                </div>

                <div id="apiKeyField" class="space-y-2">
                    <label class="text-sm text-zinc-400 font-medium">API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-..."
                        class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm mono input-focus transition-all">
                    <p class="text-xs text-zinc-500">API keys are not stored in browser, only used in session.</p>
                </div>

                <div id="modelSelectField" class="space-y-2">
                    <label class="text-sm text-zinc-400 font-medium">Model</label>
                    <div class="relative">
                        <input list="modelOptions" id="modelSelect"
                            class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm focus:border-indigo-500 focus:outline-none transition-colors"
                            placeholder="Select or type model...">
                        <datalist id="modelOptions">
                            <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                            <option value="gemini-3-flash-preview">Gemini 1.5 Pro</option>
                            <option value="gemini-pro">Gemini Pro</option>
                        </datalist>
                    </div>
                </div>

                <div id="ollamaField" class="space-y-2 hidden">
                    <label class="text-sm text-zinc-400 font-medium">Ollama URL</label>
                    <input type="text" id="ollamaUrl" value="http://localhost:11434"
                        class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm mono">
                    <label class="text-sm text-zinc-400 font-medium mt-2 block">Model</label>
                    <input type="text" id="ollamaModel" value="llama2" placeholder="llama2, mistral, etc."
                        class="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm mono">
                </div>

                <div class="pt-4 border-t border-zinc-800">
                    <button onclick="saveSettings()"
                        class="w-full btn-primary py-2.5 rounded-lg font-medium text-sm">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Mode Toggle -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex bg-zinc-900 p-1 rounded-xl border border-zinc-800">
                <button onclick="switchMode('humanize')" id="btn-humanize"
                    class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all tab-active flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    Humanizer
                </button>
                <button onclick="switchMode('write')" id="btn-write"
                    class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all text-zinc-400 hover:text-white flex items-center gap-2">
                    <i data-lucide="pen-tool" class="w-4 h-4"></i>
                    AI Writer
                </button>
                <button onclick="switchMode('check')" id="btn-check"
                    class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all text-zinc-400 hover:text-white flex items-center gap-2">
                    <i data-lucide="scan" class="w-4 h-4"></i>
                    AI Check
                </button>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">

            <!-- Input Section -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 id="inputTitle" class="text-sm font-semibold text-zinc-400 uppercase tracking-wider">Input</h3>
                    <div class="flex gap-2">
                        <input type="file" id="fileInput" class="hidden" accept=".txt,.md,.docx,.pptx"
                            onchange="uploadFile(this)">
                        <button onclick="triggerUpload()"
                            class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300">
                            <i data-lucide="upload" class="w-3 h-3"></i> Upload File
                        </button>
                        <button onclick="pasteText()"
                            class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300">
                            <i data-lucide="clipboard" class="w-3 h-3"></i> Paste
                        </button>
                        <button onclick="clearText()"
                            class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> Clear
                        </button>
                    </div>
                </div>

                <div class="relative group">
                    <textarea id="inputText"
                        placeholder="Paste AI-written text here... or write the topic your teacher gave you."
                        class="w-full h-[280px] bg-[#1a1a23] border border-zinc-800 rounded-2xl p-6 text-sm leading-relaxed resize-none input-focus card-glow mono placeholder:text-zinc-600"></textarea>
                    <div class="absolute bottom-4 right-4 text-xs text-zinc-600 mono" id="inputStats">0 words | 0
                        characters</div>
                </div>

                <button onclick="processText()" id="processBtn"
                    class="w-full btn-primary py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 group">
                    <span id="btnText">Humanize Text</span>
                    <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <!-- Chat Panel for Instructions -->
                <div class="bg-[#1a1a23] border border-zinc-800 rounded-2xl p-4 card-glow">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="message-square" class="w-4 h-4 text-violet-500"></i>
                        <h4 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Editing Instructions
                        </h4>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chatMessages" class="h-[120px] overflow-y-auto mb-3 space-y-2 text-xs">
                        <div class="text-zinc-500 italic">Type instructions to edit the result. E.g.: "Shorten paragraph
                            2" or "Make the intro more engaging"</div>
                    </div>

                    <!-- Chat Input -->
                    <div class="flex gap-2">
                        <input type="text" id="chatInput"
                            placeholder="Type your instruction... (E.g.: Make the last paragraph more casual)"
                            class="flex-1 bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm focus:border-violet-500 focus:outline-none"
                            onkeypress="if(event.key==='Enter') sendChatInstruction()">
                        <button onclick="sendChatInstruction()"
                            class="px-4 py-2 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-lg text-white text-sm font-medium flex items-center gap-1">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-sm font-semibold text-zinc-400 uppercase tracking-wider">Output</h3>
                    <div class="flex gap-2" id="outputActions" style="opacity: 0.5; pointer-events: none;">
                        <button onclick="undoText()" id="undoBtn" title="Geri Al" disabled
                            class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="undo-2" class="w-3 h-3"></i> Undo
                        </button>
                        <button onclick="redoText()" id="redoBtn" title="İleri Al" disabled
                            class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="redo-2" class="w-3 h-3"></i> Redo
                        </button>
                        <button onclick="copyOutput()"
                            class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300">
                            <i data-lucide="copy" class="w-3 h-3"></i> Copy
                        </button>
                        <!-- Download Dropdown -->
                        <div class="relative" id="downloadDropdown">
                            <button onclick="toggleDownloadMenu()"
                                class="p-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors flex items-center gap-1 text-zinc-300">
                                <i data-lucide="download" class="w-3 h-3"></i> Download
                                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                            <div id="downloadMenu"
                                class="hidden absolute top-full left-0 mt-1 bg-zinc-800 border border-zinc-700 rounded-lg shadow-xl z-50 min-w-[120px]">
                                <button onclick="downloadFile('txt'); hideDownloadMenu()"
                                    class="w-full px-3 py-2 text-xs text-left text-zinc-300 hover:bg-zinc-700 flex items-center gap-2 rounded-t-lg">
                                    <i data-lucide="file-text" class="w-3 h-3"></i> .TXT
                                </button>
                                <button onclick="downloadFile('docx'); hideDownloadMenu()"
                                    class="w-full px-3 py-2 text-xs text-left text-zinc-300 hover:bg-zinc-700 flex items-center gap-2">
                                    <i data-lucide="file" class="w-3 h-3"></i> .DOCX
                                </button>
                                <button onclick="downloadFile('md'); hideDownloadMenu()"
                                    class="w-full px-3 py-2 text-xs text-left text-zinc-300 hover:bg-zinc-700 flex items-center gap-2 rounded-b-lg">
                                    <i data-lucide="file-code" class="w-3 h-3"></i> .MD
                                </button>
                            </div>
                        </div>
                        <button onclick="autoRevise()" title="Run AI check and auto revise"
                            class="p-2 text-xs bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-lg transition-colors flex items-center gap-1 text-white font-medium">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Auto Revise
                        </button>
                    </div>
                </div>

                <div class="relative">
                    <div id="outputContainer"
                        class="w-full h-[590px] bg-[#1a1a23] border border-zinc-800 rounded-2xl p-6 text-sm leading-relaxed card-glow overflow-y-auto relative">
                        <div id="placeholderOutput"
                            class="absolute inset-0 flex items-center justify-center text-zinc-600">
                            <div class="text-center">
                                <i data-lucide="sparkles" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                                <p class="text-sm">Output will appear here...</p>
                            </div>
                        </div>

                        <div id="loadingOutput"
                            class="hidden absolute inset-0 bg-[#1a1a23]/90 backdrop-blur flex items-center justify-center">
                            <div class="text-center">
                                <div class="loading-dots mb-4 justify-center">
                                    <span></span><span></span><span></span>
                                </div>
                                <p class="text-sm text-zinc-400 mono" id="loadingText">AI is analyzing...</p>
                            </div>
                        </div>

                        <div id="resultContent" class="hidden prose prose-invert max-w-none outline-none"
                            contenteditable="true" oninput="updateOutputStats(this.innerText)">
                            <!-- Content will be inserted here -->
                        </div>

                        <!-- AI Check Results -->
                        <div id="checkResults" class="hidden space-y-4">
                            <div class="flex items-center justify-center py-8">
                                <svg class="progress-ring w-32 h-32">
                                    <circle class="text-zinc-800" stroke-width="8" stroke="currentColor"
                                        fill="transparent" r="58" cx="64" cy="64" />
                                    <circle id="scoreCircle" class="progress-ring-circle text-rose-500" stroke-width="8"
                                        stroke="currentColor" fill="transparent" r="58" cx="64" cy="64"
                                        stroke-dasharray="364.4" stroke-dashoffset="364.4" />
                                </svg>
                                <div class="absolute text-center">
                                    <div id="scorePercent" class="text-3xl font-bold">0%</div>
                                    <div id="scoreLabel" class="text-xs text-zinc-400 uppercase">AI Score</div>
                                </div>
                            </div>

                            <div class="space-y-2" id="checkDetails">
                                <!-- Details inserted here -->
                            </div>
                        </div>

                        <!-- Selection Revision Popup -->
                        <div id="selectionPopup"
                            class="hidden absolute bg-zinc-900 border border-zinc-700 rounded-xl shadow-xl p-3 z-50 min-w-[280px]">
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-zinc-400 font-medium">Revise selected text</span>
                                    <button onclick="hideSelectionPopup()" class="p-1 text-zinc-500 hover:text-white">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                                <input type="text" id="revisionInstruction"
                                    placeholder="E.g.: Make it more formal, shorten, translate..."
                                    class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs focus:border-violet-500 focus:outline-none">
                                <button onclick="reviseSelection()"
                                    class="w-full px-3 py-2 text-xs bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 rounded-lg text-white font-medium flex items-center justify-center gap-1">
                                    <i data-lucide="wand-2" class="w-3 h-3"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center text-xs text-zinc-500 px-1">
                    <span id="outputStats" class="mono">0 words | 0 characters</span>
                    <div class="flex gap-4">
                        <span id="modelInfo">Model: Gemini 3 Flash Preview</span>
                        <span id="processTime">Process time: -</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips Section -->
        <div class="mt-12 grid md:grid-cols-3 gap-4">
            <div class="p-4 rounded-xl bg-zinc-900/50 border border-zinc-800">
                <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-500 mb-2"></i>
                <h4 class="font-medium text-sm mb-1">Tip: Short Sentences</h4>
                <p class="text-xs text-zinc-400">AI tends to use sentences longer than 15 words. Humanizer breaks them
                    up.</p>
            </div>
            <div class="p-4 rounded-xl bg-zinc-900/50 border border-zinc-800">
                <i data-lucide="shield" class="w-5 h-5 text-emerald-500 mb-2"></i>
                <h4 class="font-medium text-sm mb-1">Detection Protection</h4>
                <p class="text-xs text-zinc-400">Optimized against Turnitin, GPTZero and Originality.ai.</p>
            </div>
            <div class="p-4 rounded-xl bg-zinc-900/50 border border-zinc-800">
                <i data-lucide="clock" class="w-5 h-5 text-indigo-500 mb-2"></i>
                <h4 class="font-medium text-sm mb-1">Atom Mode</h4>
                <p class="text-xs text-zinc-400">Tired student tone: "basically", "honestly", sentence fragments.</p>
            </div>
        </div>
    </main>

    <script>
        // Init Lucide icons
        lucide.createIcons();

        // Health Check Logic
        async function checkHealth() {
            const statusEl = document.getElementById('connection-status');
            const dotEl = document.getElementById('connection-dot');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch('/health', {
                    signal: controller.signal,
                    cache: 'no-store'
                });
                clearTimeout(timeoutId);

                if (response.ok) {
                    statusEl.textContent = 'Connected';
                    statusEl.classList.remove('text-rose-500');
                    dotEl.className = 'w-2 h-2 rounded-full bg-emerald-500 animate-pulse';
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                console.warn('Health check failed:', error);
                statusEl.textContent = 'Disconnected';
                statusEl.classList.add('text-rose-500');
                dotEl.className = 'w-2 h-2 rounded-full bg-rose-500';
            }
        }

        // Run check on load and every 30 seconds
        checkHealth();
        setInterval(checkHealth, 30000);

        // Notification helper function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notif = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-rose-500' : 'bg-indigo-500';
            notif.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-y-0 opacity-100`;
            notif.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}" class="w-5 h-5"></i><span>${message}</span></div>`;

            document.body.appendChild(notif);
            lucide.createIcons();

            // Auto-remove after 4 seconds
            setTimeout(() => {
                notif.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

        // Text history for undo/redo functionality
        let textHistory = [];
        let redoHistory = [];
        const MAX_HISTORY = 20;

        function saveToHistory(text) {
            if (text && text.trim()) {
                // Don't save if it's the same as the last entry
                if (textHistory.length === 0 || textHistory[textHistory.length - 1] !== text) {
                    textHistory.push(text);
                    if (textHistory.length > MAX_HISTORY) {
                        textHistory.shift(); // Remove oldest
                    }
                    // Clear redo history when new action is taken
                    redoHistory = [];
                    updateUndoRedoButtons();
                }
            }
        }

        function undoText() {
            if (textHistory.length > 1) {
                const currentText = textHistory.pop(); // Remove current
                redoHistory.push(currentText); // Save for redo
                const previousText = textHistory[textHistory.length - 1];
                const resultEl = document.getElementById('resultContent');
                resultEl.innerText = previousText;
                updateOutputStats(previousText);
                updateUndoRedoButtons();
                showNotification('Undone!', 'success');
            } else {
                showNotification('Nothing to undo!', 'error');
            }
        }

        function redoText() {
            if (redoHistory.length > 0) {
                const nextText = redoHistory.pop();
                textHistory.push(nextText);
                const resultEl = document.getElementById('resultContent');
                resultEl.innerText = nextText;
                updateOutputStats(nextText);
                updateUndoRedoButtons();
                showNotification('Redone!', 'success');
            } else {
                showNotification('Nothing to redo!', 'error');
            }
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) {
                undoBtn.disabled = textHistory.length <= 1;
            }
            if (redoBtn) {
                redoBtn.disabled = redoHistory.length === 0;
            }
        }

        // Download menu functions
        function toggleDownloadMenu() {
            const menu = document.getElementById('downloadMenu');
            menu.classList.toggle('hidden');
            lucide.createIcons();
        }

        function hideDownloadMenu() {
            const menu = document.getElementById('downloadMenu');
            menu.classList.add('hidden');
        }

        // Close download menu when clicking outside
        document.addEventListener('click', function (e) {
            const dropdown = document.getElementById('downloadDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                hideDownloadMenu();
            }
        });

        let currentMode = 'humanize';

        function switchMode(mode) {
            currentMode = mode;

            // Update buttons
            ['humanize', 'write', 'check'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if (m === mode) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-zinc-400');
                    btn.classList.add('flex', 'items-center', 'gap-2'); // Ensure these are present if removed by other classes
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-zinc-400');
                    btn.classList.add('hover:text-white', 'flex', 'items-center', 'gap-2'); // Ensure these are present
                }
            });

            // Clear output when switching modes
            document.getElementById('resultContent').innerText = '';
            document.getElementById('resultContent').classList.add('hidden'); // Hide result content
            document.getElementById('checkResults').classList.add('hidden'); // Hide check results
            document.getElementById('placeholderOutput').classList.remove('hidden'); // Show placeholder
            document.getElementById('outputActions').style.opacity = '0.5';
            document.getElementById('outputActions').style.pointerEvents = 'none';


            // Update placeholders and UI
            const inputTitle = document.getElementById('inputTitle');
            const input = document.getElementById('inputText');
            const btnText = document.getElementById('btnText');

            if (mode === 'humanize') {
                if (inputTitle) inputTitle.innerText = 'Input';
                input.placeholder = "Paste AI-written text here...";
                btnText.innerHTML = 'Humanize Text';
                document.getElementById('processBtn').innerHTML = `<span id="btnText">Humanize Text</span><i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>`
            } else if (mode === 'write') {
                if (inputTitle) inputTitle.innerText = 'Topic';
                input.placeholder = "What topic should I write about? E.g.: '800 word essay about coffee addiction at 2am'";
                btnText.innerHTML = 'Generate Text';
                document.getElementById('processBtn').innerHTML = `<span id="btnText">Generate Text</span><i data-lucide="pen-tool" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>`
            } else if (mode === 'check') {
                if (inputTitle) inputTitle.innerText = 'Text to Check';
                input.placeholder = "Paste text to check for AI detection...";
                btnText.innerHTML = 'Run AI Check';
                document.getElementById('processBtn').innerHTML = `<span id="btnText">Run AI Check</span><i data-lucide="scan" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>`
            }
            lucide.createIcons();
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function updateProviderFields() {
            const provider = document.getElementById('providerSelect').value;
            const apiKeyField = document.getElementById('apiKeyField');
            const ollamaField = document.getElementById('ollamaField');
            const modelOptions = document.getElementById('modelOptions');
            const modelInput = document.getElementById('modelSelect');

            if (provider === 'ollama') {
                apiKeyField.classList.add('hidden');
                ollamaField.classList.remove('hidden');
                document.getElementById('modelSelectField').classList.add('hidden');
            } else {
                apiKeyField.classList.remove('hidden');
                ollamaField.classList.add('hidden');
                document.getElementById('modelSelectField').classList.remove('hidden');

                if (provider === 'gemini') {
                    modelOptions.innerHTML = `
                        <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                        <option value="gemini-3-flash-preview">Gemini 1.5 Pro</option>
                        <option value="gemini-pro">Gemini Pro</option>
                    `;
                    if (!modelInput.value) modelInput.value = "gemini-3-flash-preview";
                } else if (provider === 'openrouter') {
                    modelOptions.innerHTML = `
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                        <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                        <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                    `;
                    if (!modelInput.value) modelInput.value = "anthropic/claude-3.5-sonnet";
                }
            }
        }

        async function processText() {
            const text = document.getElementById('inputText').value;
            if (!text.trim()) return;

            const loadingEl = document.getElementById('loadingOutput');
            const placeholderEl = document.getElementById('placeholderOutput');
            const resultEl = document.getElementById('resultContent');
            const checkEl = document.getElementById('checkResults');
            const btn = document.getElementById('processBtn');

            loadingEl.classList.remove('hidden');
            placeholderEl.classList.add('hidden');
            resultEl.classList.add('hidden');
            checkEl.classList.add('hidden');
            btn.disabled = true;

            const startTime = Date.now();

            try {
                if (currentMode === 'check') {
                    await performAICheck(text);
                } else {
                    await generateText(text);
                }

                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('processTime').textContent = `Process time: ${duration}s`;
                document.getElementById('outputActions').style.opacity = '1';
                document.getElementById('outputActions').style.pointerEvents = 'all';

            } catch (error) {
                alert('Error: ' + error.message);
                placeholderEl.classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
                btn.disabled = false;
            }
        }

        async function generateText(inputText) {
            const provider = localStorage.getItem('provider') || 'gemini';
            const apiKey = localStorage.getItem('apiKey') || '';
            const model = localStorage.getItem('model') || 'gemini-3-flash-preview';
            const ollamaUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434';
            const ollamaModel = localStorage.getItem('ollamaModel') || 'llama2';

            let endpoint = '/api/humanize';
            let payload = {
                text: inputText,
                provider: provider,
                apiKey: apiKey,
                model: model,
                ollamaUrl: ollamaUrl,
                ollamaModel: ollamaModel
            };

            if (currentMode === 'write') {
                endpoint = '/api/write';
                payload = {
                    topic: inputText,
                    provider: provider,
                    apiKey: apiKey,
                    model: model,
                    ollamaUrl: ollamaUrl,
                    ollamaModel: ollamaModel
                };
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'API request failed');
            }

            // Prepare UI for streaming
            const resultEl = document.getElementById('resultContent');
            const loadingEl = document.getElementById('loadingOutput');

            // HIDE loading blur immediately when stream starts
            loadingEl.classList.add('hidden');

            resultEl.innerText = '';
            resultEl.classList.remove('hidden');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.slice(6);
                        if (dataStr === '[DONE]') continue;

                        try {
                            const data = JSON.parse(dataStr);
                            if (data.error) {
                                throw new Error(data.error);
                            } else if (data.chunk) {
                                resultEl.innerText += data.chunk;
                            }
                        } catch (e) {
                            console.error('Error parsing JSON chunk', e);
                        }
                    }
                }
            }

            // Final flush
            if (buffer.startsWith('data: ')) {
                const dataStr = buffer.slice(6);
                if (dataStr !== '[DONE]') {
                    try {
                        const data = JSON.parse(dataStr);
                        if (data.chunk) resultEl.innerText += data.chunk;
                    } catch (e) { }
                }
            }
            updateOutputStats(resultEl.innerText);
            saveToHistory(resultEl.innerText); // Save to history for undo
        }

        async function performAICheck(text) {
            const provider = document.getElementById('providerSelect').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            const ollamaUrl = document.getElementById('ollamaUrl').value;
            const ollamaModel = document.getElementById('ollamaModel').value;

            const response = await fetch('/api/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    provider: provider,
                    apiKey: apiKey,
                    model: model,
                    ollamaUrl: ollamaUrl,
                    ollamaModel: ollamaModel
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'AI Check failed');
            }

            const data = await response.json();
            // Data structure: { ai_score, sentence_analysis, overall_feedback, reasons... }
            displayCheckResult(data.ai_score, data.reasons, data.sentence_analysis, data.overall_feedback);
        }

        async function autoRevise() {
            const resultEl = document.getElementById('resultContent');
            const text = resultEl.innerText.trim();

            if (!text) {
                showNotification('No text to revise!', 'error');
                return;
            }

            const provider = document.getElementById('providerSelect').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            const ollamaUrl = document.getElementById('ollamaUrl').value;
            const ollamaModel = document.getElementById('ollamaModel').value;

            // Show loading state
            const loadingEl = document.getElementById('loadingOutput');
            const loadingText = document.getElementById('loadingText');
            loadingEl.classList.remove('hidden');
            loadingText.textContent = 'Auto revising...';

            try {
                const response = await fetch('/api/auto-revise', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        provider: provider,
                        apiKey: apiKey,
                        model: model,
                        ollamaUrl: ollamaUrl,
                        ollamaModel: ollamaModel,
                        targetScore: 15,
                        maxIterations: 3
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Auto-revise failed');
                }

                const data = await response.json();

                // Display the revised text
                resultEl.innerText = data.final_text;
                updateOutputStats(data.final_text);

                // Show iteration history in check results
                let iterHtml = '<div class="mb-4 p-3 bg-zinc-900 rounded-lg border border-zinc-800">';
                iterHtml += '<h4 class="text-sm font-semibold text-zinc-300 mb-2">Revision History:</h4>';
                iterHtml += '<div class="flex gap-2 flex-wrap">';
                data.iterations.forEach((iter, idx) => {
                    const color = iter.score <= 15 ? 'bg-emerald-500/20 text-emerald-400' :
                        iter.score <= 40 ? 'bg-yellow-500/20 text-yellow-400' :
                            'bg-rose-500/20 text-rose-400';
                    iterHtml += `<span class="px-2 py-1 rounded text-xs ${color}">Attempt ${iter.iteration}: ${iter.score.toFixed(1)}%</span>`;
                    if (idx < data.iterations.length - 1) {
                        iterHtml += '<span class="text-zinc-500">→</span>';
                    }
                });
                iterHtml += '</div></div>';

                // Display final score
                displayCheckResult(data.final_score, [], [], iterHtml + 'Final AI Score: ' + data.final_score.toFixed(1) + '%');

                showNotification(`Revision complete! Final score: ${data.final_score.toFixed(1)}%`, 'success');

            } catch (error) {
                console.error('Auto-revise error:', error);
                showNotification('Auto revise error: ' + error.message, 'error');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // Selection-based revision
        let savedSelection = null;
        let savedRange = null;

        document.getElementById('resultContent').addEventListener('mouseup', function (e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText.length > 5) {
                savedSelection = selection;
                savedRange = selection.getRangeAt(0).cloneRange();

                const popup = document.getElementById('selectionPopup');
                const rect = savedRange.getBoundingClientRect();
                const containerRect = document.getElementById('outputContainer').getBoundingClientRect();

                popup.style.top = (rect.bottom - containerRect.top + 10) + 'px';
                popup.style.left = (rect.left - containerRect.left) + 'px';
                popup.classList.remove('hidden');
                lucide.createIcons();
            } else {
                hideSelectionPopup();
            }
        });

        function hideSelectionPopup() {
            document.getElementById('selectionPopup').classList.add('hidden');
            savedSelection = null;
            savedRange = null;
        }

        async function reviseSelection() {
            if (!savedRange) {
                showNotification('Please select some text first!', 'error');
                return;
            }

            const selectedText = savedRange.toString();
            if (selectedText.length < 5) {
                showNotification('Please select longer text!', 'error');
                return;
            }

            const instruction = document.getElementById('revisionInstruction').value.trim();
            const provider = document.getElementById('providerSelect').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            hideSelectionPopup();
            showNotification('Revising selected text...', 'info');

            try {
                // Use the new /api/edit endpoint for selection-based editing
                const response = await fetch('/api/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: selectedText,
                        instruction: instruction || 'Rewrite more naturally and fluently',
                        provider: provider,
                        apiKey: apiKey,
                        model: model
                    })
                });

                if (!response.ok) {
                    throw new Error('Revision failed');
                }

                // Read the stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let revisedText = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.chunk) revisedText += data.chunk;
                            } catch (e) { }
                        }
                    }
                }

                // Replace the selected text with revised text
                const resultEl = document.getElementById('resultContent');
                const fullText = resultEl.innerText;
                saveToHistory(fullText); // Save current state before change
                const newText = fullText.replace(selectedText, revisedText.trim());
                resultEl.innerText = newText;
                updateOutputStats(newText);
                saveToHistory(newText); // Save new state

                showNotification('Selected text revised!', 'success');

            } catch (error) {
                console.error('Selection revision error:', error);
                showNotification('Revision error: ' + error.message, 'error');
            }
        }

        // Hide popup when clicking outside
        document.addEventListener('mousedown', function (e) {
            const popup = document.getElementById('selectionPopup');
            if (!popup.contains(e.target) && e.target.id !== 'resultContent') {
                hideSelectionPopup();
            }
        });

        // Chat-based instruction system
        async function sendChatInstruction() {
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            const instruction = chatInput.value.trim();

            if (!instruction) {
                showNotification('Please enter a message!', 'error');
                return;
            }

            const resultEl = document.getElementById('resultContent');
            const currentText = resultEl.innerText.trim();

            if (!currentText) {
                showNotification('Generate some text first!', 'error');
                return;
            }

            const provider = document.getElementById('providerSelect').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            // Save current text to history before any changes
            saveToHistory(currentText);

            // Add user message to chat
            chatMessages.innerHTML += `
                <div class="flex justify-end">
                    <div class="bg-violet-600/20 text-violet-300 px-3 py-2 rounded-lg max-w-[80%]">${instruction}</div>
                </div>
            `;
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Show loading message
            const loadingId = 'loading-' + Date.now();
            chatMessages.innerHTML += `
                <div id="${loadingId}" class="flex justify-start">
                    <div class="bg-zinc-800 text-zinc-400 px-3 py-2 rounded-lg">
                        <span class="animate-pulse">Thinking...</span>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Use the new /api/chat endpoint that can handle both Q&A and edits
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: instruction,
                        text: currentText,
                        provider: provider,
                        apiKey: apiKey,
                        model: model
                    })
                });

                if (!response.ok) {
                    throw new Error('Chat failed');
                }

                // Read the stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let responseText = '';
                let responseType = 'answer'; // default

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type) responseType = data.type;
                                if (data.chunk) responseText += data.chunk;
                            } catch (e) { }
                        }
                    }
                }

                // Remove loading message
                document.getElementById(loadingId)?.remove();

                if (responseType === 'answer') {
                    // This was a question - show the answer in chat
                    chatMessages.innerHTML += `
                        <div class="flex justify-start">
                            <div class="bg-indigo-600/20 text-indigo-300 px-3 py-2 rounded-lg max-w-[90%]">${responseText.trim()}</div>
                        </div>
                    `;
                    showNotification('Answer provided!', 'success');
                } else {
                    // This was an edit - update the result
                    chatMessages.innerHTML += `
                        <div class="flex justify-start">
                            <div class="bg-emerald-600/20 text-emerald-300 px-3 py-2 rounded-lg">✓ Edit applied</div>
                        </div>
                    `;

                    const newText = responseText.trim();
                    resultEl.innerText = newText;
                    updateOutputStats(newText);
                    saveToHistory(newText);
                    showNotification('Text edited!', 'success');
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                document.getElementById(loadingId)?.remove();
                chatMessages.innerHTML += `
                    <div class="flex justify-start">
                        <div class="bg-rose-600/20 text-rose-300 px-3 py-2 rounded-lg">Error: ${error.message}</div>
                    </div>
                `;
                console.error('Chat error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function displayResult(text) {
            const resultEl = document.getElementById('resultContent');
            resultEl.innerHTML = text.replace(/\n/g, '<br>');
            resultEl.classList.remove('hidden');
            updateOutputStats(text);
        }

        function updateOutputStats(text) {
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            document.getElementById('outputStats').innerText = `${words} words | ${chars} characters`;
        }

        function displayCheckResult(score, reasons, sentenceAnalysis, feedback) {
            const checkEl = document.getElementById('checkResults');
            const circle = document.getElementById('scoreCircle');
            const percent = document.getElementById('scorePercent');
            const details = document.getElementById('checkDetails');

            const scoreFloat = parseFloat(score);
            const circumference = 2 * Math.PI * 58;
            const offset = circumference - (scoreFloat / 100) * circumference;

            circle.style.strokeDashoffset = offset;

            // Color based on score
            let color = 'text-emerald-500';
            if (scoreFloat > 70) color = 'text-rose-500';
            else if (scoreFloat > 40) color = 'text-yellow-500';

            circle.setAttribute('class', `progress-ring-circle ${color}`);
            percent.setAttribute('class', `text-3xl font-bold ${color}`);
            percent.textContent = `${scoreFloat}%`;

            let html = '';

            if (feedback) {
                html += `<div class="p-3 bg-zinc-900 rounded-lg text-sm text-zinc-300 border border-zinc-800 mb-4">
                    <strong class="block text-white mb-1">Genel Değerlendirme:</strong> ${feedback}
                </div>`;
            }

            if (sentenceAnalysis && Array.isArray(sentenceAnalysis)) {
                html += '<div class="space-y-3 mt-4">';
                sentenceAnalysis.forEach(item => {
                    const itemScore = parseFloat(item.score);
                    let itemColor = 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20';
                    if (itemScore > 70) itemColor = 'bg-rose-500/10 text-rose-400 border-rose-500/20';
                    else if (itemScore > 40) itemColor = 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20';

                    html += `
                        <div class="p-3 rounded-lg border ${itemColor} text-xs">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold">AI Score: ${itemScore}%</span>
                            </div>
                            <p class="mb-1 italic">"${item.sentence}"</p>
                            <p class="opacity-70 text-[10px] uppercase tracking-wider">${item.reason}</p>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (reasons) {
                html += reasons.map(r => `
                    <div class="flex items-start gap-2 text-sm text-zinc-300">
                        <i data-lucide="info" class="w-4 h-4 text-zinc-500 mt-0.5 flex-shrink-0"></i>
                        <span>${r}</span>
                    </div>
                `).join('');
            }

            details.innerHTML = html;
            lucide.createIcons();
            checkEl.classList.remove('hidden');
        }

        async function copyOutput() {
            const text = document.getElementById('resultContent').innerText;
            if (!text) return;

            try {
                await navigator.clipboard.writeText(text);
                showCopyFeedback();
            } catch (err) {
                console.warn('Clipboard API failed, trying fallback...');
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;

            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback();
                } else {
                    alert('Copy failed.');
                }
            } catch (err) {
                console.error('Fallback copy failed', err);
                alert('Copy failed: ' + err);
            }

        }

        function showCopyFeedback() {
            // Optional: Add visual feedback (like a toast or button text change)
            const btn = document.querySelector('button[onclick="copyOutput()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Copied';
            lucide.createIcons();

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        }

        async function pasteText() {
            const inputEl = document.getElementById('inputText');

            // Check if clipboard API is available (HTTPS only)
            if (navigator.clipboard && navigator.clipboard.readText) {
                try {
                    const text = await navigator.clipboard.readText();
                    inputEl.value = text;
                    updateStats(text);
                    showNotification('Text pasted!', 'success');
                    return;
                } catch (err) {
                    console.warn('Clipboard API failed, using fallback:', err);
                }
            }

            // Fallback: Focus the input and prompt user to use Ctrl+V
            inputEl.focus();
            showNotification('Please use Ctrl+V to paste', 'info');
        }

        function clearText() {
            document.getElementById('inputText').value = '';
            document.getElementById('inputStats').innerText = "0 words | 0 characters";
        }

        function updateStats(text) {
            if (typeof text !== 'string') text = document.getElementById('inputText').value || '';
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            document.getElementById('inputStats').innerText = `${words} words | ${chars} characters`;
        }

        // Monitor input for stats
        document.getElementById('inputText').addEventListener('input', (e) => {
            updateStats(e.target.value);
        });

        function triggerUpload() {
            document.getElementById('fileInput').click();
        }

        async function uploadFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Upload failed');

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    document.getElementById('inputText').value = data.text;
                    updateStats(data.text);
                } catch (e) {
                    alert('File upload error: ' + e.message);
                }

                // Reset input
                input.value = '';
            }
        }

        async function downloadFile(format) {
            const text = document.getElementById('resultContent').innerText;
            if (!text) return;

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        format: format
                    })
                });

                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `humanized_text.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (e) {
                alert('İndirme hatası: ' + e.message);
            }
        }



        function saveSettings() {
            const provider = document.getElementById('providerSelect').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            localStorage.setItem('provider', provider);
            if (apiKey) localStorage.setItem('apiKey', apiKey);
            localStorage.setItem('model', model);

            if (provider === 'ollama') {
                localStorage.setItem('ollamaUrl', document.getElementById('ollamaUrl').value);
                localStorage.setItem('ollamaModel', document.getElementById('ollamaModel').value);
            }

            document.getElementById('modelInfo').textContent = `Model: ${model}`;
            toggleSettings();
        }

        // Auto-save input
        document.getElementById('inputText').addEventListener('input', updateStats);

        // Load settings on startup
        window.addEventListener('load', () => {
            const savedProvider = localStorage.getItem('provider');
            const savedModel = localStorage.getItem('model');
            const savedApiKey = localStorage.getItem('apiKey');
            const savedOllamaUrl = localStorage.getItem('ollamaUrl');
            const savedOllamaModel = localStorage.getItem('ollamaModel');

            if (savedProvider) {
                document.getElementById('providerSelect').value = savedProvider;
            }

            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            if (savedOllamaUrl) {
                document.getElementById('ollamaUrl').value = savedOllamaUrl;
            }

            if (savedOllamaModel) {
                document.getElementById('ollamaModel').value = savedOllamaModel;
            }

            // Update UI based on provider
            updateProviderFields();

            // Restore model AFTER updating fields (to prevent overwrite)
            if (savedModel && savedProvider !== 'ollama') {
                const modelInput = document.getElementById('modelSelect');
                if (modelInput) modelInput.value = savedModel;
            }
        });
    </script>
</body>

</html>